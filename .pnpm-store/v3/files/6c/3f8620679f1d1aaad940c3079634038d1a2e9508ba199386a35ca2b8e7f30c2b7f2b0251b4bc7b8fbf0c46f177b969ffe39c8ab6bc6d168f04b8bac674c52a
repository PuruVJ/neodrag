{"version":3,"names":["getTDZStatus","refPath","bindingPath","executionStatus","_guessExecutionStatusRelativeTo","skipTDZChecks","WeakSet","buildTDZAssert","status","node","state","clone","t","cloneNode","add","callExpression","addHelper","stringLiteral","name","isReference","scope","declared","letReferences","get","getBindingIdentifier","getTDZReplacement","path","id","has","getBinding","isFunctionDeclaration","parent","_tdzThis","visitor","ReferencedIdentifier","tdzEnabled","parentPath","isUpdateExpression","isFor","left","replacement","replaceWith","UpdateExpression","arg","isIdentifier","insertBefore","AssignmentExpression","nodes","ids","getBindingIdentifiers","Object","keys","push","expressionStatement","length"],"sources":["../src/tdz.ts"],"sourcesContent":["import { types as t, type PluginPass } from \"@babel/core\";\nimport type { NodePath, Scope, Visitor } from \"@babel/traverse\";\n\nfunction getTDZStatus(refPath: NodePath, bindingPath: NodePath) {\n  const executionStatus = bindingPath._guessExecutionStatusRelativeTo(refPath);\n\n  if (executionStatus === \"before\") {\n    return \"outside\";\n  } else if (executionStatus === \"after\") {\n    return \"inside\";\n  } else {\n    return \"maybe\";\n  }\n}\n\nexport const skipTDZChecks = new WeakSet();\n\nfunction buildTDZAssert(\n  status: \"maybe\" | \"inside\",\n  node: t.Identifier | t.JSXIdentifier,\n  state: TDZVisitorState,\n) {\n  if (status === \"maybe\") {\n    const clone = t.cloneNode(node);\n    skipTDZChecks.add(clone);\n    return t.callExpression(state.addHelper(\"temporalRef\"), [\n      // @ts-expect-error Fixme: we may need to handle JSXIdentifier\n      clone,\n      t.stringLiteral(node.name),\n    ]);\n  } else {\n    return t.callExpression(state.addHelper(\"tdz\"), [\n      t.stringLiteral(node.name),\n    ]);\n  }\n}\n\nfunction isReference(\n  node: t.Identifier | t.JSXIdentifier,\n  scope: Scope,\n  state: TDZVisitorState,\n) {\n  const declared = state.letReferences.get(node.name);\n  if (!declared) return false;\n\n  // declared node is different in this scope\n  return scope.getBindingIdentifier(node.name) === declared;\n}\n\ntype TDZReplacement = { status: \"maybe\" | \"inside\"; node: t.Expression };\nfunction getTDZReplacement(\n  path: NodePath<t.Identifier | t.JSXIdentifier>,\n  state: TDZVisitorState,\n): TDZReplacement | undefined;\nfunction getTDZReplacement(\n  path: NodePath,\n  state: TDZVisitorState,\n  id: t.Identifier | t.JSXIdentifier,\n): TDZReplacement | undefined;\nfunction getTDZReplacement(\n  path: NodePath,\n  state: TDZVisitorState,\n  id: t.Identifier | t.JSXIdentifier = path.node as any,\n): TDZReplacement | undefined {\n  if (!isReference(id, path.scope, state)) return;\n\n  if (skipTDZChecks.has(id)) return;\n  skipTDZChecks.add(id);\n\n  const bindingPath = path.scope.getBinding(id.name).path;\n\n  if (bindingPath.isFunctionDeclaration()) return;\n\n  const status = getTDZStatus(path, bindingPath);\n  if (status === \"outside\") return;\n\n  if (status === \"maybe\") {\n    // add tdzThis to parent variable declarator so it's exploded\n    // @ts-expect-error todo(flow->ts): avoid mutations\n    bindingPath.parent._tdzThis = true;\n  }\n\n  return { status, node: buildTDZAssert(status, id, state) };\n}\n\nexport interface TDZVisitorState {\n  tdzEnabled: boolean;\n  addHelper: PluginPass[\"addHelper\"];\n  letReferences: Map<string, t.Identifier>;\n}\n\nexport const visitor: Visitor<TDZVisitorState> = {\n  ReferencedIdentifier(path, state) {\n    if (!state.tdzEnabled) return;\n    if (path.parentPath.isUpdateExpression()) return;\n    // It will be handled after transforming the loop\n    if (path.parentPath.isFor({ left: path.node })) return;\n\n    const replacement = getTDZReplacement(path, state);\n    if (!replacement) return;\n\n    path.replaceWith(replacement.node);\n  },\n\n  UpdateExpression(path, state) {\n    if (!state.tdzEnabled) return;\n\n    const { node } = path;\n    if (skipTDZChecks.has(node)) return;\n    skipTDZChecks.add(node);\n\n    const arg = path.get(\"argument\");\n    if (!arg.isIdentifier()) return;\n\n    const replacement = getTDZReplacement(path, state, arg.node);\n    if (!replacement) return;\n\n    if (replacement.status === \"maybe\") {\n      path.insertBefore(replacement.node);\n    } else {\n      path.replaceWith(replacement.node);\n    }\n  },\n\n  AssignmentExpression(path, state) {\n    if (!state.tdzEnabled) return;\n\n    const { node } = path;\n    if (skipTDZChecks.has(node)) return;\n    skipTDZChecks.add(node);\n\n    const nodes = [];\n    const ids = path.getBindingIdentifiers();\n\n    for (const name of Object.keys(ids)) {\n      const replacement = getTDZReplacement(path, state, ids[name]);\n      if (replacement) {\n        nodes.push(t.expressionStatement(replacement.node));\n        if (replacement.status === \"inside\") break;\n      }\n    }\n\n    if (nodes.length > 0) path.insertBefore(nodes);\n  },\n};\n"],"mappings":"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"}